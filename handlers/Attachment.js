/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.declare("fcg.mdg.editbp.handlers.Attachment");jQuery.sap.require("sap.m.UploadCollectionParameter");jQuery.sap.require("sap.m.MessageBox");fcg.mdg.editbp.handlers.Attachment={oController:"",oUpload:false,onBeforeUploadFile:function(e){var f="";var t=this.getXsrfToken();var c=new sap.m.UploadCollectionParameter({name:"X-CSRF-Token",value:t});var h=this.oFileUpload.getHeaderParameters();if(h[0]===undefined){this.oFileUpload.addHeaderParameter(c);}var a=this.oFileUpload.getHeaderParameters()[0].getValue("X-CSRF-Token");if(a===""){this.oFileUpload.addHeaderParameter(c);}f=e.getParameter("mParameters").files[0].name;var C=new sap.m.UploadCollectionParameter({name:"slug",value:f});var h=this.oFileUpload.getHeaderParameters();this.oFileUpload.removeHeaderParameter(h[1]);this.oFileUpload.addHeaderParameter(C);},onFileStartsUploading:function(e){this.oFileUpload.setUploadEnabled(false);fcg.mdg.editbp.handlers.Attachment.oUpload=true;},onUploadFile:function(e){var c,m,g,u,n,f;var r=e.getParameters().getParameters().responseRaw;var p=new DOMParser();var x=p.parseFromString(r,"text/xml");c=x.getElementsByTagName("d:CreatedBy")[0].childNodes[0].nodeValue;m=x.getElementsByTagName("d:MimeType")[0].childNodes[0].nodeValue;g=x.getElementsByTagName("d:Guid")[0].childNodes[0].nodeValue;u=x.getElementsByTagName("id")[0].childNodes[0].nodeValue;n=u+'/$value';f=e.getParameters().getParameters().fileName;var C=function(){var b=new Date();var h=b.getDate();var i=b.getMonth()+1;var y=b.getFullYear();if(h<10){h='0'+h;}if(i<10){i='0'+i;}return y+'-'+i+'-'+h;};if(g!==""){var d=this.attachDataModel.getData();var o={"mimeType":m,"contributor":c,"uploaded":C(),"enableEdit":false,"enableDelete":true,"filename":f,"url":n,"documentId":g};d.dataitems.unshift(o);this.attachDataModel.setData(d);this.oFileUpload.getBinding("items").refresh(true);this.oFileUpload.rerender();var G={Guid:g};this.oAttach.push(G);var a=fcg.mdg.editbp.handlers.Attachment.oController.oRequestReason;if(a.getValue()===""){a.setValue(this.i18nBundle.getText("AFTER_UPLOAD"));}a.fireEvent("change");this.onAttachmentChange();}this.oFileUpload.setUploadEnabled(true);fcg.mdg.editbp.handlers.Attachment.oUpload=false;},onFileDeleted:function(e){var d=e.getParameter("documentId");var a=this.attachDataModel.getData();if(this.oFileUpload.getUploadEnabled()===true){for(var i=0;i<a.dataitems.length;i++){if(a.dataitems[i].documentId===d){a.dataitems.splice(i,1);break;}}for(var i=0;i<this.oAttach.length;i++){if(this.oAttach[i].Guid===d){this.oAttach.splice(i,1);break;}}this.attachDataModel.setData(a);this.oFileUpload.getBinding("items").refresh(true);this.oFileUpload.rerender();this.onAttachmentChange();if(this.oAttach.length===0){if(fcg.mdg.editbp.handlers.Attachment.oController.oRequestReason.getValue()===this.i18nBundle.getText("AFTER_UPLOAD")){fcg.mdg.editbp.handlers.Attachment.oController.oRequestReason.setValue("");fcg.mdg.editbp.handlers.Attachment.oController.oRequestReason.fireEvent("change");}}this.oFileUpload.setUploadEnabled(true);fcg.mdg.editbp.handlers.Attachment.oUpload=false;}else{var b=this.i18nBundle.getText("ATTACH_UPLOAD");this.showErrorDialog(b);}},onFileUploadFailed:function(e){MessageBox.error(e.getParameters().exception.message);},uploadTerminated:function(e){var f=e.getParameters("fileName");var F=f.id;var a=this.oFileUpload.getItems();for(var i=0;i<a.length;i++){if(this.oFileUpload.getId()===F){a.splice(i,1);break;}}this.oFileUpload.setUploadEnabled(true);fcg.mdg.editbp.handlers.Attachment.oUpload=false;},showErrorDialog:function(e){if(e&&e.trim()){var a={};a.details=e;sap.m.MessageBox.error(a.details);}}};
